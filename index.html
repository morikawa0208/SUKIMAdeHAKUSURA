import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Sword, Shield, Zap, Heart, ShoppingBag, DollarSign, Play, Skull, Trophy, Trash2, Info, PlusCircle, Hammer, Sparkles } from 'lucide-react';

const generateId = () => Math.random().toString(36).substr(2, 9);

const ITEM_TYPES = {
  SWORD: { id: 'sword', name: '鉄の剣', type: 'weapon', w: 1, h: 2, baseDamage: 8, cooldown: 1800, staminaCost: 0.7, icon: Sword, color: 'bg-slate-300 border-slate-500', desc: '標準的な武器。', synergy: { with: ['whetstone'], effect: (base) => ({ ...base, damage: base.damage + 4 }), desc: '砥石に隣接: ダメージ+4' } },
  WHETSTONE: { id: 'whetstone', name: '砥石', type: 'accessory', w: 1, h: 1, icon: Hammer, color: 'bg-gray-400 border-gray-600', desc: '隣接する武器を強化する。', synergy: { with: ['sword', 'axe', 'dagger'], effect: (base) => base, desc: '武器に隣接して強化' } },
  DAGGER: { id: 'dagger', name: 'ダガー', type: 'weapon', w: 1, h: 1, baseDamage: 4, cooldown: 600, staminaCost: 0.4, icon: Sword, color: 'bg-teal-300 border-teal-500', desc: '高速攻撃。', synergy: { with: ['potion'], effect: (base) => ({ ...base, cooldown: base.cooldown * 0.8 }), desc: 'ポーションに隣接: 速度+20%' } },
  AXE: { id: 'axe', name: '戦斧', type: 'weapon', w: 2, h: 2, baseDamage: 22, cooldown: 3000, staminaCost: 2.5, icon: Zap, color: 'bg-red-300 border-red-500', desc: '重い一撃。', synergy: { with: ['crystal'], effect: (base) => ({ ...base, staminaCost: base.staminaCost * 0.7 }), desc: '石に隣接: 消費-30%' } },
  SHIELD: { id: 'shield', name: '木の盾', type: 'armor', w: 2, h: 2, block: 8, cooldown: 2200, staminaCost: 0, icon: Shield, color: 'bg-amber-700 border-amber-900', desc: '防御用。', synergy: { with: ['shield'], effect: (base) => ({ ...base, block: base.block + 4 }), desc: '他の盾に隣接: 防御+4' } },
  POTION: { id: 'potion', name: '回復薬', type: 'consumable', w: 1, h: 1, heal: 30, trigger: 'low_hp', cooldown: 5000, staminaCost: 0, icon: Heart, color: 'bg-pink-400 border-pink-600', desc: 'HP50%以下で使用。' },
  MANA_CRYSTAL: { id: 'crystal', name: 'スタミナ石', type: 'accessory', w: 1, h: 1, staminaRegen: 0.8, cooldown: 0, staminaCost: 0, icon: Zap, color: 'bg-blue-300 border-blue-500', desc: '回復速度アップ。' },
  BAG_SLOT: { id: 'bag_slot', name: 'バッグの小袋', type: 'utility', isSlot: true, price: 5, color: 'bg-amber-100 border-amber-400', desc: 'バッグの空きマスを増やす。' }
};

const RARITIES = [
  { name: 'Common', color: 'text-gray-200', mult: 1.0, border: 'border-gray-500' },
  { name: 'Rare', color: 'text-blue-400', mult: 1.25, border: 'border-blue-500' },
  { name: 'Epic', color: 'text-purple-400', mult: 1.6, border: 'border-purple-500' },
  { name: 'Legendary', color: 'text-yellow-400', mult: 2.2, border: 'border-yellow-500' },
];

export default function App() {
  const [phase, setPhase] = useState('inventory'); 
  const [floor, setFloor] = useState(1);
  const [gold, setGold] = useState(15);
  const [inventory, setInventory] = useState([]);
  const [unlockedSlots, setUnlockedSlots] = useState(() => {
    const initial = [];
    for(let y=0; y<5; y++) for(let x=0; x<4; x++) initial.push(`${x},${y}`);
    return initial;
  });

  // UI States (Separated from game logic for stability)
  const [displayPlayer, setDisplayPlayer] = useState({ hp: 100, maxHp: 100, stamina: 10, maxStamina: 10, block: 0 });
  const [displayEnemy, setDisplayEnemy] = useState(null);
  const [combatLog, setCombatLog] = useState([]);
  const [shopItems, setShopItems] = useState([]);
  const [selectedItem, setSelectedItem] = useState(null);
  const [showDetail, setShowDetail] = useState(null);

  // Battle Logic Engine (Fully contained in Ref)
  const engineRef = useRef({
    active: false,
    player: { hp: 100, maxHp: 100, stamina: 10, maxStamina: 10, block: 0 },
    enemy: null,
    itemCds: {},
    timer: null
  });

  useEffect(() => {
    const startItem = { ...ITEM_TYPES.SWORD, instanceId: generateId(), rarity: RARITIES[0] };
    setInventory([{ ...startItem, x: 0, y: 0 }]);
  }, []);

  const isSlotUnlocked = (x, y) => unlockedSlots.includes(`${x},${y}`);

  const checkSynergy = (item, currentInventory) => {
    if (!item.synergy) return { active: false };
    const neighbors = currentInventory.filter(other => {
      if (other.instanceId === item.instanceId) return false;
      const xOverlap = (other.x < item.x + item.w && other.x + other.w > item.x);
      const yOverlap = (other.y < item.y + item.h && other.y + other.h > item.y);
      const xAdjacent = (Math.abs(other.x - (item.x + item.w)) === 0 || Math.abs(item.x - (other.x + other.w)) === 0);
      const yAdjacent = (Math.abs(other.y - (item.y + item.h)) === 0 || Math.abs(item.y - (other.y + other.h)) === 0);
      return (xOverlap && yAdjacent) || (yOverlap && xAdjacent);
    }).filter(other => item.synergy.with.includes(other.id) || item.synergy.with.includes(other.type));
    return neighbors.length > 0 ? { active: true, neighbors } : { active: false };
  };

  const getEffectiveStats = (item, currentInventory) => {
    let stats = {
      damage: (item.baseDamage || 0) * item.rarity.mult,
      cooldown: item.cooldown || 0,
      staminaCost: item.staminaCost || 0,
      block: item.block || 0,
      heal: (item.heal || 0) * item.rarity.mult,
      staminaRegen: item.staminaRegen || 0
    };
    if (item.synergy && checkSynergy(item, currentInventory).active) stats = item.synergy.effect(stats);
    currentInventory.forEach(other => {
      if (other.instanceId === item.instanceId || !other.synergy) return;
      const s = checkSynergy(other, currentInventory);
      if (s.active && s.neighbors.some(n => n.instanceId === item.instanceId)) {
        if (other.id === 'whetstone' && item.type === 'weapon') stats.damage += 4;
      }
    });
    return stats;
  };

  const startBattle = () => {
    const hp = 60 + floor * 20;
    const enemyData = { name: `Monster LV.${floor}`, hp, maxHp: hp, damage: 5 + floor, nextAttack: 1500 };
    
    engineRef.current = {
      active: true,
      player: { hp: 100, maxHp: 100, stamina: 10, maxStamina: 10, block: 0 },
      enemy: enemyData,
      itemCds: {},
      timer: null
    };

    setDisplayPlayer({ ...engineRef.current.player });
    setDisplayEnemy(enemyData);
    setCombatLog([{ text: `Floor ${floor} - 戦闘開始！`, type: 'info', id: Date.now() }]);
    setPhase('battle');
  };

  // The Pure Battle Engine Tick
  useEffect(() => {
    if (phase !== 'battle' || !engineRef.current.active) return;

    const tickRate = 50;
    const interval = setInterval(() => {
      const engine = engineRef.current;
      if (!engine.active) return;

      // 1. Stamina Regen
      let regen = 1.5;
      inventory.forEach(it => { regen += getEffectiveStats(it, inventory).staminaRegen; });
      engine.player.stamina = Math.min(engine.player.maxStamina, engine.player.stamina + regen * (tickRate / 1000));

      // 2. Player Actions
      inventory.forEach(item => {
        let cd = engine.itemCds[item.instanceId] || 0;
        if (cd > 0) {
          engine.itemCds[item.instanceId] = Math.max(0, cd - tickRate);
          return;
        }
        const stats = getEffectiveStats(item, inventory);
        let acted = false;
        if (item.type === 'weapon' && engine.player.stamina >= stats.staminaCost) {
          engine.enemy.hp -= Math.floor(stats.damage);
          engine.player.stamina -= stats.staminaCost;
          setCombatLog(l => [{ text: `${item.name}: ${Math.floor(stats.damage)} dmg`, type: 'player', id: Math.random() }, ...l].slice(0, 5));
          acted = true;
        } else if (item.type === 'armor') {
          engine.player.block += stats.block;
          setCombatLog(l => [{ text: `${item.name}: +${stats.block} block`, type: 'player', id: Math.random() }, ...l].slice(0, 5));
          acted = true;
        } else if (item.type === 'consumable' && item.trigger === 'low_hp' && engine.player.hp < engine.player.maxHp * 0.5) {
          engine.player.hp = Math.min(engine.player.maxHp, engine.player.hp + stats.heal);
          setCombatLog(l => [{ text: `${item.name}: +${stats.heal} HP`, type: 'heal', id: Math.random() }, ...l].slice(0, 5));
          acted = true;
        }
        if (acted) engine.itemCds[item.instanceId] = stats.cooldown;
      });

      // 3. Enemy Action
      engine.enemy.nextAttack -= tickRate;
      if (engine.enemy.nextAttack <= 0) {
        const blk = Math.min(engine.player.block, engine.enemy.damage);
        engine.player.block -= blk;
        engine.player.hp -= (engine.enemy.damage - blk);
        engine.enemy.nextAttack = 2500;
        setCombatLog(l => [{ text: `Enemy: ${engine.enemy.damage} (${blk} block)`, type: 'enemy', id: Math.random() }, ...l].slice(0, 5));
      }

      // 4. Update UI
      setDisplayPlayer({ ...engine.player });
      setDisplayEnemy({ ...engine.enemy });

      // 5. Check Win/Loss
      if (engine.enemy.hp <= 0) {
        engine.active = false;
        clearInterval(interval);
        handleWin();
      } else if (engine.player.hp <= 0) {
        engine.active = false;
        clearInterval(interval);
        setPhase('gameover');
      }
    }, tickRate);

    return () => clearInterval(interval);
  }, [phase, inventory, floor]);

  const handleWin = () => {
    setGold(g => g + 10 + floor);
    const newItems = [];
    const keys = Object.keys(ITEM_TYPES).filter(k => k !== 'BAG_SLOT');
    for(let i=0; i<2; i++) {
        const t = ITEM_TYPES[keys[Math.floor(Math.random() * keys.length)]];
        const r = Math.random() > 0.8 ? RARITIES[1] : RARITIES[0];
        newItems.push({ ...t, instanceId: generateId(), rarity: r, price: Math.floor(8 * r.mult) });
    }
    newItems.push({ ...ITEM_TYPES.BAG_SLOT, instanceId: generateId(), price: 5 });
    setShopItems(newItems);
    setPhase('loot');
  };

  const buyItem = (item) => {
    if (gold < item.price) return;
    if (item.isSlot) {
      setGold(g => g - item.price);
      setShopItems(s => s.filter(i => i.instanceId !== item.instanceId));
      for(let x=0; x<6; x++) {
        for(let y=0; y<5; y++) {
          if (!isSlotUnlocked(x, y)) {
            setUnlockedSlots(prev => [...prev, `${x},${y}`]);
            return;
          }
        }
      }
    } else {
      for(let y=0; y<5; y++) {
        for(let x=0; x<6; x++) {
          if (canPlace(item, x, y)) {
            setGold(g => g - item.price);
            setInventory(prev => [...prev, { ...item, x, y }]);
            setShopItems(s => s.filter(i => i.instanceId !== item.instanceId));
            return;
          }
        }
      }
    }
  };

  const canPlace = (item, x, y, ignoreId = null) => {
    if (x < 0 || y < 0 || x + item.w > 6 || y + item.h > 5) return false;
    for (let i = 0; i < item.w; i++) {
      for (let j = 0; j < item.h; j++) {
        const cx = x + i, cy = y + j;
        if (!isSlotUnlocked(cx, cy)) return false;
        if (inventory.some(it => it.instanceId !== ignoreId && cx >= it.x && cx < it.x + it.w && cy >= it.y && cy < it.y + it.h)) return false;
      }
    }
    return true;
  };

  const moveItem = (instanceId, x, y) => {
    const item = inventory.find(i => i.instanceId === instanceId);
    if (item && canPlace(item, x, y, instanceId)) {
      setInventory(prev => prev.map(it => it.instanceId === instanceId ? { ...it, x, y } : it));
      setSelectedItem(null);
    }
  };

  return (
    <div className="w-full h-screen bg-slate-950 text-slate-100 flex flex-col overflow-hidden select-none">
      <header className="h-14 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-4 shrink-0">
        <div className="flex items-center gap-2">
            <div className="p-1.5 bg-yellow-500 rounded-lg"><ShoppingBag size={20} className="text-slate-900"/></div>
            <span className="font-black text-lg italic">BP DUNGEON</span>
        </div>
        <div className="flex items-center gap-4">
          <div className="flex items-center gap-1.5 bg-slate-800 px-3 py-1 rounded-full"><DollarSign size={16} className="text-yellow-400"/><span className="font-mono font-bold">{gold}</span></div>
          <div className="text-slate-400 font-black text-sm uppercase">Fl.{floor}</div>
        </div>
      </header>

      <main className="flex-1 flex flex-col items-center p-2 gap-2 overflow-hidden max-w-md mx-auto w-full">
        <div className="w-full bg-slate-900 p-3 rounded-xl border border-slate-800 shadow-xl space-y-2">
             <div className="flex justify-between items-center px-1">
                <span className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Player Status</span>
                <span className="text-xs text-blue-400 font-bold flex items-center bg-blue-400/10 px-2 py-0.5 rounded-full"><Shield size={12} className="mr-1"/>{Math.floor(displayPlayer.block)}</span>
             </div>
             <div className="space-y-1.5">
                <div className="w-full h-4 bg-slate-800 rounded-full relative overflow-hidden">
                    <div className="absolute top-0 left-0 h-full bg-emerald-500" style={{ width: `${Math.max(0, (displayPlayer.hp/displayPlayer.maxHp)*100)}%` }} />
                    <div className="absolute inset-0 flex items-center justify-center text-[10px] font-black">HP {Math.max(0, Math.ceil(displayPlayer.hp))}</div>
                </div>
                <div className="w-full h-2 bg-slate-800 rounded-full relative overflow-hidden">
                    <div className="absolute top-0 left-0 h-full bg-amber-500" style={{ width: `${(displayPlayer.stamina/displayPlayer.maxStamina)*100}%` }} />
                </div>
             </div>
             {displayEnemy && phase === 'battle' && (
                <div className="pt-1 border-t border-slate-800">
                    <div className="w-full h-3 bg-slate-800 rounded-full relative overflow-hidden">
                        <div className="absolute top-0 left-0 h-full bg-red-600" style={{ width: `${Math.max(0, (displayEnemy.hp/displayEnemy.maxHp)*100)}%` }} />
                        <div className="absolute inset-0 flex items-center justify-center text-[9px] font-black">{displayEnemy.name}: {Math.max(0, Math.ceil(displayEnemy.hp))}</div>
                    </div>
                </div>
             )}
        </div>

        <div className="relative p-2 bg-slate-900 rounded-2xl border-4 border-slate-800">
            <div className="relative" style={{ width: 6 * 44, height: 5 * 44 }}>
                {Array.from({ length: 30 }).map((_, i) => {
                    const x = i % 6, y = Math.floor(i / 6);
                    return <div key={i} onClick={() => selectedItem && moveItem(selectedItem.instanceId, x, y)} className={`absolute w-[40px] h-[40px] rounded-md m-[2px] ${isSlotUnlocked(x, y) ? 'bg-slate-800 border border-slate-700/30' : 'bg-black opacity-20'}`} style={{ left: x * 44, top: y * 44 }} />;
                })}
                {inventory.map(item => {
                    const stats = getEffectiveStats(item, inventory);
                    const syn = checkSynergy(item, inventory);
                    const isSelected = selectedItem?.instanceId === item.instanceId;
                    const cdVal = engineRef.current.itemCds[item.instanceId] || 0;
                    return (
                        <div key={item.instanceId} onClick={() => (phase !== 'battle') && setSelectedItem(isSelected ? null : item)} className={`absolute m-[2px] rounded-lg border-2 shadow-lg flex items-center justify-center ${item.color} ${item.rarity.border} ${isSelected ? 'ring-4 ring-white z-50' : 'z-10'} ${syn.active ? 'ring-2 ring-yellow-400' : ''}`} style={{ left: item.x * 44, top: item.y * 44, width: item.w * 44 - 4, height: item.h * 44 - 4 }}>
                            <item.icon size={20} className="text-slate-900 opacity-60" />
                            <div className="absolute bottom-0 right-0.5 bg-black/80 px-1 rounded text-[9px] font-black text-white pointer-events-none">
                                {item.type === 'weapon' && Math.floor(stats.damage)}
                                {item.type === 'armor' && stats.block}
                                {item.type === 'accessory' && stats.staminaRegen > 0 && `+${stats.staminaRegen}`}
                                {item.type === 'consumable' && stats.heal}
                            </div>
                            <button onClick={(e) => { e.stopPropagation(); setShowDetail(item); }} className="absolute top-0.5 left-0.5 p-0.5 bg-white/20 rounded-full"><Info size={8}/></button>
                            {phase === 'battle' && cdVal > 0 && <div className="absolute inset-0 bg-black/50 overflow-hidden rounded-md"><div className="w-full bg-white/20 absolute bottom-0" style={{ height: `${(cdVal/stats.cooldown)*100}%` }} /></div>}
                        </div>
                    );
                })}
            </div>
        </div>

        <div className="w-full flex-1 flex flex-col bg-slate-900/50 rounded-2xl border border-slate-800 overflow-hidden">
            {(phase === 'inventory' || phase === 'loot') && (
                <div className="flex-1 flex flex-col p-3">
                    <div className="flex justify-between items-center mb-2">
                        <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">{phase === 'loot' ? 'Loot & Shop' : 'Backpack'}</span>
                        {selectedItem && <button onClick={() => { setGold(g => g + 4); setInventory(inventory.filter(i => i.instanceId !== selectedItem.instanceId)); setSelectedItem(null); }} className="text-[10px] text-red-400 font-bold bg-red-400/10 px-2 py-1 rounded">SELL (+4G)</button>}
                    </div>
                    {phase === 'loot' && (
                        <div className="flex gap-2 overflow-x-auto pb-2 mb-2 scrollbar-hide">
                            {shopItems.map(item => (
                                <div key={item.instanceId} className={`shrink-0 w-28 bg-slate-800 border-2 rounded-xl p-2 flex flex-col ${item.rarity.border} ${gold < item.price ? 'opacity-40' : ''}`}>
                                    <div className="flex justify-between mb-1"><div className={`w-6 h-6 ${item.color} rounded flex items-center justify-center`}><item.icon size={12} className="text-slate-900"/></div><span className="text-[10px] font-bold text-yellow-500">{item.price}G</span></div>
                                    <div className="text-[10px] font-bold truncate">{item.name}</div>
                                    <button disabled={gold < item.price} onClick={() => buyItem(item)} className="mt-2 py-1 bg-yellow-500 text-slate-950 rounded text-[10px] font-black">GET</button>
                                </div>
                            ))}
                        </div>
                    )}
                    <button onClick={phase === 'inventory' ? startBattle : () => { setFloor(f => f + 1); setPhase('inventory'); }} className="w-full py-4 mt-auto bg-yellow-500 text-slate-950 rounded-xl font-black text-lg">
                        {phase === 'inventory' ? 'BATTLE START' : 'NEXT FLOOR'}
                    </button>
                </div>
            )}
            {phase === 'battle' && (
                <div className="flex-1 overflow-y-auto p-3 text-[11px] font-mono space-y-1">
                    {combatLog.map(log => <div key={log.id} className={`border-l-4 pl-2 ${log.type === 'player' ? 'border-emerald-500 text-emerald-200' : log.type === 'enemy' ? 'border-red-500 text-red-200' : 'border-slate-700 text-slate-400'}`}>{log.text}</div>)}
                </div>
            )}
        </div>

        {showDetail && (
            <div className="fixed inset-0 z-[100] bg-black/80 flex items-center justify-center p-4" onClick={() => setShowDetail(null)}>
                <div className="bg-slate-900 border-2 border-slate-700 w-full max-w-xs rounded-2xl p-5" onClick={e => e.stopPropagation()}>
                    <div className="flex items-center gap-4 mb-4"><div className={`w-14 h-14 ${showDetail.color} rounded-xl flex items-center justify-center border-4 ${showDetail.rarity.border}`}><showDetail.icon size={28} className="text-slate-900"/></div><div><div className={`text-lg font-black ${showDetail.rarity.color}`}>{showDetail.name}</div><div className="text-[10px] text-slate-500">{showDetail.type.toUpperCase()}</div></div></div>
                    <div className="bg-black/30 p-3 rounded-xl mb-4 text-[11px] italic">"{showDetail.desc}"</div>
                    {showDetail.synergy && <div className={`p-2 rounded-lg border-2 text-[10px] ${checkSynergy(showDetail, inventory).active ? 'bg-yellow-400/10 border-yellow-400 text-yellow-200' : 'border-slate-700 opacity-50'}`}>{showDetail.synergy.desc}</div>}
                    <button onClick={() => setShowDetail(null)} className="w-full py-3 mt-4 bg-slate-800 text-white font-black rounded-xl">CLOSE</button>
                </div>
            </div>
        )}
        {phase === 'gameover' && <div className="fixed inset-0 z-[200] bg-black/95 flex flex-col items-center justify-center p-8 text-center animate-in zoom-in-95"><Skull size={64} className="text-red-600 mb-4" /><h2 className="text-4xl font-black mb-4 uppercase">Defeat</h2><button onClick={() => window.location.reload()} className="bg-white text-black px-12 py-3 rounded-full font-black">REBIRTH</button></div>}
      </main>
    </div>
  );
}

