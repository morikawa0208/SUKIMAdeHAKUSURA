<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>White Dungeon - Mobile Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 2px; }

        /* Bars */
        .bar-container { background-color: #e2e8f0; border-radius: 9999px; overflow: hidden; height: 10px; }
        .hp-fill { background-color: #ef4444; height: 100%; transition: width 0.3s ease; }
        .mp-fill { background-color: #3b82f6; height: 100%; transition: width 0.3s ease; }
        .exp-fill { background-color: #fbbf24; height: 100%; transition: width 0.3s ease; }

        /* Animations */
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-30px) scale(1.2); }
        }
        .damage-text {
            position: absolute;
            font-weight: 800;
            text-shadow: 1px 1px 0 #fff;
            animation: floatUp 0.8s forwards;
            pointer-events: none;
            z-index: 50;
        }

        .shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .rarity-common { color: #4b5563; }
        .rarity-uncommon { color: #16a34a; font-weight: bold; }
        .rarity-rare { color: #2563eb; font-weight: bold; }
        .rarity-epic { color: #9333ea; font-weight: bold; text-shadow: 0 0 5px rgba(147, 51, 234, 0.2); }
        .rarity-legendary { color: #ea580c; font-weight: bold; text-shadow: 0 0 5px rgba(234, 88, 12, 0.3); }

        /* Tab Active State */
        .tab-btn.active {
            border-bottom: 3px solid #1f2937;
            color: #1f2937;
            background-color: #f3f4f6;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden bg-white text-gray-800">

    <!-- HEADER -->
    <header class="h-12 bg-white border-b flex items-center justify-between px-4 shrink-0 shadow-sm z-20">
        <div class="font-bold text-gray-800 flex items-center gap-2">
            <i class="fas fa-dungeon text-gray-400"></i>
            <span>Âú∞‰∏ã <span id="floor-display" class="text-xl">1</span> Èöé</span>
        </div>
        <div class="text-xs font-mono bg-gray-100 px-2 py-1 rounded text-gray-600">
            Enemy Lv.<span id="enemy-lvl-display">1</span>
        </div>
    </header>

    <!-- MAIN CONTENT AREA (Split Layout on Desktop, Vertical on Mobile) -->
    <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <!-- BATTLE AREA (Top/Left) -->
        <div id="battle-area" class="flex-1 flex flex-col relative bg-gray-50 md:border-r border-gray-200 transition-colors duration-500">
            
            <!-- Enemy Section -->
            <div class="flex-1 flex flex-col justify-center items-center relative p-4 min-h-[180px]">
                <div id="enemy-container" class="text-center w-full max-w-xs transition-opacity duration-300">
                    <div id="enemy-visual" class="text-7xl text-gray-700 mb-3 drop-shadow-sm transition-transform">
                        <i class="fas fa-ghost"></i>
                    </div>
                    <div class="flex items-center justify-center gap-2 mb-1">
                        <h2 id="enemy-name" class="font-bold text-lg">„Åï„Åæ„Çà„ÅÜÈ≠Ç</h2>
                    </div>
                    
                    <!-- Enemy HP -->
                    <div class="relative w-full h-4 bg-gray-300 rounded-full overflow-hidden border border-gray-400">
                        <div id="enemy-hp-bar" class="hp-fill w-full"></div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1 font-mono text-right"><span id="enemy-hp-text">100/100</span> HP</div>
                </div>

                <!-- Floating Damage Layer -->
                <div id="damage-layer" class="absolute inset-0 pointer-events-none overflow-hidden"></div>
            </div>

            <!-- Player Status & Controls -->
            <div class="bg-white p-4 border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-10 shrink-0">
                
                <!-- Player Bars -->
                <div class="flex gap-3 mb-3 text-sm">
                    <div class="flex-1">
                        <div class="flex justify-between mb-1 text-xs font-bold text-gray-600">
                            <span>HP</span>
                            <span id="player-hp-text">100/100</span>
                        </div>
                        <div class="bar-container bg-red-100"><div id="player-hp-bar" class="hp-fill"></div></div>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between mb-1 text-xs font-bold text-gray-600">
                            <span>MP</span>
                            <span id="player-mp-text">30/30</span>
                        </div>
                        <div class="bar-container bg-blue-100"><div id="player-mp-bar" class="mp-fill"></div></div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="flex flex-col gap-2">
                    <select id="skill-select" class="w-full bg-gray-50 border border-gray-300 text-gray-700 text-sm rounded p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none mb-1">
                        <!-- Skills injected here -->
                    </select>

                    <button id="action-btn" class="w-full bg-gray-800 text-white font-bold h-14 rounded-lg shadow-lg active:scale-[0.98] transition-all text-lg flex items-center justify-center gap-2 touch-manipulation">
                        <i class="fas fa-sword"></i>
                        <span>ÊîªÊíÉ„Åô„Çã</span>
                    </button>
                </div>
            </div>
            
            <!-- Game Over Overlay (Hidden by default) -->
            <div id="game-over-overlay" class="absolute inset-0 bg-red-900/30 pointer-events-none opacity-0 transition-opacity duration-500 flex items-center justify-center z-0">
                <div class="text-4xl font-bold text-red-600 -rotate-12 border-4 border-red-600 p-4 rounded opacity-0 transform scale-150 transition-all duration-500" id="dead-text">DEATH</div>
            </div>
        </div>

        <!-- INFO PANEL (Bottom/Right - Tabbed) -->
        <div class="h-[40vh] md:h-full md:w-96 flex flex-col bg-white border-t md:border-t-0 md:border-l border-gray-200 shrink-0">
            
            <!-- Tab Header -->
            <div class="flex border-b border-gray-200 text-sm font-bold text-gray-500 bg-gray-50">
                <button onclick="switchTab('log')" id="tab-log" class="tab-btn active flex-1 py-3 text-center transition-colors">„É≠„Ç∞</button>
                <button onclick="switchTab('status')" id="tab-status" class="tab-btn flex-1 py-3 text-center transition-colors">„Çπ„ÉÜ„Éº„Çø„Çπ</button>
                <button onclick="switchTab('inventory')" id="tab-inventory" class="tab-btn flex-1 py-3 text-center transition-colors">ÊåÅ„Å°Áâ© <span id="inv-badge" class="ml-1 text-[10px] bg-gray-400 text-white px-1.5 rounded-full">0</span></button>
            </div>

            <!-- Tab Content Area -->
            <div class="flex-1 overflow-hidden relative bg-white">
                
                <!-- LOG TAB -->
                <div id="content-log" class="tab-content active h-full overflow-y-auto custom-scroll p-3 font-mono text-xs leading-5">
                    <div class="text-gray-400 pb-2 border-b mb-2">--- Battle Log ---</div>
                    <div id="log-container" class="flex flex-col gap-1"></div>
                </div>

                <!-- STATUS TAB -->
                <div id="content-status" class="tab-content h-full overflow-y-auto custom-scroll p-4">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-lg font-bold">Player Lv.<span id="status-lvl">1</span></span>
                        <div class="text-xs text-gray-500 flex flex-col items-end">
                            <span>EXP: <span id="status-exp">0/100</span></span>
                            <div class="w-24 h-1.5 bg-gray-200 rounded mt-1"><div id="status-exp-bar" class="exp-fill w-0"></div></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <div class="p-3 bg-gray-50 border rounded text-center">
                            <div class="text-xs text-gray-500">STR (ÊîªÊíÉ)</div>
                            <div id="status-atk" class="text-xl font-bold text-gray-800">10</div>
                        </div>
                        <div class="p-3 bg-gray-50 border rounded text-center">
                            <div class="text-xs text-gray-500">VIT (Èò≤Âæ°)</div>
                            <div id="status-def" class="text-xl font-bold text-gray-800">5</div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="text-xs font-bold text-gray-400 uppercase">Ë£ÖÂÇô</div>
                        <div class="p-2 border rounded flex items-center gap-3">
                            <i class="fas fa-hammer text-gray-400 w-6 text-center"></i>
                            <div class="flex-1 min-w-0">
                                <div class="text-[10px] text-gray-400">Ê≠¶Âô®</div>
                                <div id="equip-weapon" class="font-bold text-sm truncate">„Å™„Åó</div>
                            </div>
                            <div id="weapon-stats" class="text-xs font-bold text-gray-500"></div>
                        </div>
                        <div class="p-2 border rounded flex items-center gap-3">
                            <i class="fas fa-shield-alt text-gray-400 w-6 text-center"></i>
                            <div class="flex-1 min-w-0">
                                <div class="text-[10px] text-gray-400">Èò≤ÂÖ∑</div>
                                <div id="equip-armor" class="font-bold text-sm truncate">„Å™„Åó</div>
                            </div>
                            <div id="armor-stats" class="text-xs font-bold text-gray-500"></div>
                        </div>
                    </div>

                    <button id="rest-btn" class="mt-6 w-full py-3 bg-green-50 text-green-700 border border-green-200 rounded font-bold text-sm hover:bg-green-100 transition-colors">
                        <i class="fas fa-bed mr-2"></i>‰ºëÊÅØ„Åô„Çã (ÂÖ®ÂõûÂæ©)
                    </button>
                    <p class="text-[10px] text-center text-gray-400 mt-1">‚ÄªÊà¶Èóò‰∏≠‰ª•Â§ñ„ÅÆ„Åø</p>
                </div>

                <!-- INVENTORY TAB -->
                <div id="content-inventory" class="tab-content h-full overflow-y-auto custom-scroll p-2">
                    <div id="inventory-list" class="space-y-2 pb-4"></div>
                    <div id="empty-inv-msg" class="text-center text-gray-400 text-sm mt-10 italic">ÊåÅ„Å°Áâ©„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOOT MODAL -->
    <div id="loot-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-xl shadow-2xl p-5 text-center transform scale-100 transition-all">
            <div class="text-5xl mb-4 text-yellow-500 drop-shadow-md animate-bounce">üéÅ</div>
            <h3 class="text-lg font-bold mb-1">„ÅäÂÆùÁô∫Ë¶ãÔºÅ</h3>
            
            <div id="loot-display" class="bg-gray-50 border border-gray-200 p-3 rounded-lg my-4">
                <!-- content -->
            </div>

            <div class="flex gap-3">
                <button onclick="discardLoot()" class="flex-1 py-3 text-sm font-bold text-gray-500 bg-gray-100 rounded-lg active:bg-gray-200">Êç®„Å¶„Çã</button>
                <button onclick="takeLoot()" class="flex-1 py-3 text-sm font-bold text-white bg-blue-600 rounded-lg shadow-lg active:bg-blue-700">Êãæ„ÅÜ</button>
            </div>
        </div>
    </div>

    <script>
        // --- GAME CONFIG & STATE ---
        const CONFIG = {
            baseExp: 20,
            maxInventory: 20
        };

        const Game = {
            floor: 1,
            state: 'idle', // idle, combat, loot, dead
            player: {
                level: 1,
                currentHp: 100, maxHp: 100,
                currentMp: 30, maxMp: 30,
                baseStr: 10, baseDef: 5,
                exp: 0, nextLevelExp: 100,
                equipment: { weapon: null, armor: null },
                inventory: []
            },
            enemy: null,
            tempLoot: null
        };

        // --- DATABASE ---
        const Skills = [
            { id: 0, name: 'ÈÄöÂ∏∏ÊîªÊíÉ', mp: 0, power: 1.0, type: 'phys' },
            { id: 1, name: 'Âº∑ÊíÉ', mp: 5, power: 1.5, type: 'phys' },
            { id: 2, name: '‰∫åÈÄ£Êñ¨„Çä', mp: 8, power: 0.9, hits: 2, type: 'phys' },
            { id: 3, name: '„Éí„Éº„É´', mp: 10, power: 0, type: 'heal', amount: 35 },
            { id: 4, name: '„Éï„Ç°„Ç§„Ç¢', mp: 12, power: 2.5, type: 'mag' },
            { id: 5, name: 'ÂÖúÂâ≤„Çä', mp: 15, power: 2.0, type: 'phys' } // High cost
        ];

        const Enemies = [
            { name: "„Çπ„É©„Ç§„É†", icon: "fa-bacteria", hp: 30, str: 8, exp: 10 },
            { name: "„É©„ÉÉ„Éà", icon: "fa-otter", hp: 40, str: 10, exp: 12 },
            { name: "„Ç¥„Éñ„É™„É≥", icon: "fa-user-secret", hp: 55, str: 13, exp: 18 },
            { name: "„Éê„ÉÉ„Éà", icon: "fa-crow", hp: 45, str: 15, exp: 15 },
            { name: "„Çπ„Ç±„É´„Éà„É≥", icon: "fa-skull", hp: 70, str: 18, exp: 25 },
            { name: "„Ç™„Éº„ÇØ", icon: "fa-hippo", hp: 120, str: 22, exp: 40 },
            { name: "Ê≠ªÁ•û", icon: "fa-scythe", hp: 200, str: 35, exp: 80 },
            { name: "„Éâ„É©„Ç¥„É≥", icon: "fa-dragon", hp: 350, str: 50, exp: 150 }
        ];

        const Prefixes = [
            { name: "„Éú„É≠„ÅÆ", mul: 0.8, rarity: "common" },
            { name: "ÊôÆÈÄö„ÅÆ", mul: 1.0, rarity: "common" },
            { name: "ËâØË≥™„Å™", mul: 1.2, rarity: "uncommon" },
            { name: "Èã≠Âà©„Å™", mul: 1.3, rarity: "uncommon" },
            { name: "ÁÜüÁ∑¥„ÅÆ", mul: 1.5, rarity: "rare" },
            { name: "ÂÆàË≠∑„ÅÆ", mul: 1.6, rarity: "rare" },
            { name: "Ëã±ÈõÑ„ÅÆ", mul: 2.0, rarity: "epic" },
            { name: "‰ºùË™¨„ÅÆ", mul: 3.0, rarity: "legendary" },
            { name: "Á•ûÊÆ∫„Åó„ÅÆ", mul: 5.0, rarity: "legendary" }
        ];

        // --- INIT ---
        window.onload = () => {
            initSkillSelect();
            startFloor();
            log("„ÉÄ„É≥„Ç∏„Éß„É≥„Å´ÂÖ•„Å£„Åü...", "text-gray-500 italic");
        };

        function initSkillSelect() {
            const el = document.getElementById('skill-select');
            Skills.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = `${s.name} (MP:${s.mp})`;
                el.appendChild(opt);
            });
        }

        // --- CORE GAMEPLAY ---
        function startFloor() {
            // Pick enemy based on floor
            const difficulty = Math.floor((Game.floor - 1) * 0.4);
            const range = Math.min(Enemies.length, 3 + Math.floor(Game.floor / 5));
            const idx = Math.min(Enemies.length - 1, Math.floor(Math.random() * range) + Math.floor(difficulty / 2));
            const base = Enemies[Math.min(idx, Enemies.length - 1)];

            const scale = 1 + (Game.floor * 0.15);

            Game.enemy = {
                ...base,
                maxHp: Math.floor(base.hp * scale),
                currentHp: Math.floor(base.hp * scale),
                str: Math.floor(base.str * scale),
                exp: Math.floor(base.exp * scale)
            };
            
            Game.state = 'combat';
            updateUI();
        }

        document.getElementById('action-btn').onclick = () => {
            if (Game.state === 'dead') {
                resetGame();
                return;
            }
            if (Game.state === 'loot') return; // Modal open

            // Next Floor / Spawn Logic
            if (Game.state === 'idle') {
                Game.floor++;
                startFloor();
                log(`Âú∞‰∏ã${Game.floor}Èöé„Å∏ÈÄ≤„Çì„Å†„ÄÇ`);
                return;
            }

            // Player Turn
            if (Game.state === 'combat') {
                const skillId = document.getElementById('skill-select').value;
                const skill = Skills.find(s => s.id == skillId);
                
                if (Game.player.currentMp >= skill.mp) {
                    performSkill(skill);
                } else {
                    log("MP‰∏çË∂≥ÔºÅÈÄöÂ∏∏ÊîªÊíÉÔºÅ", "text-blue-500");
                    performSkill(Skills[0]);
                }

                if (Game.enemy.currentHp <= 0) {
                    winBattle();
                } else {
                    // Enemy Turn delayed
                    setTimeout(() => {
                        if (Game.state === 'combat') enemyAction();
                    }, 400);
                }
            }
        };

        function performSkill(skill) {
            Game.player.currentMp -= skill.mp;
            const pStats = getStats();
            
            if (skill.type === 'heal') {
                const healAmt = Math.floor(skill.amount + (pStats.str * 0.5));
                const old = Game.player.currentHp;
                Game.player.currentHp = Math.min(Game.player.maxHp, Game.player.currentHp + healAmt);
                const val = Game.player.currentHp - old;
                log(`${skill.name}ÔºÅ HP${val}ÂõûÂæ©`, "text-green-600");
                spawnDamageText(val, 'heal');
            } else {
                let hits = skill.hits || 1;
                let total = 0;
                for(let i=0; i<hits; i++) {
                    let dmg = Math.floor(skill.power * pStats.str * (0.9 + Math.random() * 0.2));
                    dmg = Math.max(1, dmg);
                    Game.enemy.currentHp = Math.max(0, Game.enemy.currentHp - dmg);
                    total += dmg;
                }
                
                // Shake
                const vis = document.getElementById('enemy-visual');
                vis.classList.remove('shake');
                void vis.offsetWidth;
                vis.classList.add('shake');

                log(`${skill.name}ÔºÅ ${total}„ÉÄ„É°„Éº„Ç∏`);
                spawnDamageText(total, 'dmg');
            }
            updateUI();
        }

        function enemyAction() {
            if (Game.state !== 'combat') return;
            
            const pStats = getStats();
            let dmg = Math.floor(Game.enemy.str * (0.9 + Math.random() * 0.2)) - pStats.def;
            dmg = Math.max(1, dmg);

            Game.player.currentHp = Math.max(0, Game.player.currentHp - dmg);
            log(`${Game.enemy.name}„ÅÆÊîªÊíÉÔºÅ ${dmg}„ÉÄ„É°„Éº„Ç∏`, "text-red-500");
            
            if (Game.player.currentHp <= 0) {
                handleDeath();
            }
            updateUI();
        }

        function handleDeath() {
            Game.state = 'dead';
            log("ÁõÆ„ÅÆÂâç„ÅåÁúü„Å£Êöó„Å´„Å™„Å£„Åü...", "font-bold text-red-600");
            
            // UI Effects
            document.getElementById('game-over-overlay').style.opacity = '1';
            document.getElementById('game-over-overlay').style.pointerEvents = 'auto';
            setTimeout(() => {
                document.getElementById('dead-text').style.opacity = '1';
                document.getElementById('dead-text').style.transform = 'scale(1) rotate(-12deg)';
            }, 100);

            // Update Button
            const btn = document.getElementById('action-btn');
            btn.classList.remove('bg-gray-800');
            btn.classList.add('bg-red-700');
            btn.innerHTML = '<i class="fas fa-skull"></i> Ëòá„Çã („É™„Çª„ÉÉ„Éà)';
        }

        function resetGame() {
            // Reset Data
            Game.floor = 1;
            Game.player.level = 1;
            Game.player.exp = 0;
            Game.player.nextLevelExp = 100;
            Game.player.maxHp = 100; Game.player.currentHp = 100;
            Game.player.maxMp = 30; Game.player.currentMp = 30;
            Game.player.baseStr = 10; Game.player.baseDef = 5;
            Game.player.equipment = { weapon: null, armor: null };
            Game.player.inventory = [];
            
            // Reset UI State
            Game.state = 'idle';
            document.getElementById('game-over-overlay').style.opacity = '0';
            document.getElementById('game-over-overlay').style.pointerEvents = 'none';
            document.getElementById('dead-text').style.opacity = '0';
            document.getElementById('dead-text').style.transform = 'scale(1.5)';
            
            document.getElementById('log-container').innerHTML = ''; // Clear log
            log("Â•≥Á•û„ÅÆÂä†Ë≠∑„Å´„Çà„ÇäËòá„Å£„ÅüÔºÅ", "text-yellow-600 font-bold");

            startFloor();
        }

        function winBattle() {
            Game.state = 'idle';
            Game.enemy.currentHp = 0;
            
            // Exp
            Game.player.exp += Game.enemy.exp;
            log(`${Game.enemy.name}„ÇíÂÄí„Åó„ÅüÔºÅ (EXP+${Game.enemy.exp})`, "font-bold");
            
            if (Game.player.exp >= Game.player.nextLevelExp) {
                Game.player.level++;
                Game.player.exp -= Game.player.nextLevelExp;
                Game.player.nextLevelExp = Math.floor(Game.player.nextLevelExp * 1.5);
                Game.player.maxHp += 15; Game.player.currentHp = Game.player.maxHp;
                Game.player.maxMp += 5; Game.player.currentMp = Game.player.maxMp;
                Game.player.baseStr += 2; Game.player.baseDef += 1;
                log(`„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ (Lv.${Game.player.level})`, "text-yellow-600 font-bold");
            }

            // Drop?
            if (Math.random() < 0.6) {
                generateLoot();
            } else {
                updateUI();
            }
        }

        // --- LOOT ---
        function generateLoot() {
            const isWeapon = Math.random() < 0.6;
            const type = isWeapon ? 'weapon' : 'armor';
            const baseVal = Game.floor * 3 + (isWeapon ? 5 : 2);
            
            // Random Prefix
            const pIdx = Math.min(Prefixes.length - 1, Math.floor(Math.random() * (Prefixes.length)));
            // Weighted random could be better but simple random for now, slightly biased to lower
            let prefix = Prefixes[Math.floor(Math.random() * Prefixes.length)];
            // Bias towards common early
            if (Game.floor < 5 && prefix.rarity === 'legendary') prefix = Prefixes[0];

            const val = Math.floor(baseVal * prefix.mul * (0.8 + Math.random() * 0.4));
            
            Game.tempLoot = {
                id: Date.now(),
                name: `${prefix.name}${isWeapon ? 'Ââ£' : 'Èéß'}`,
                type: type,
                val: val,
                rarity: prefix.rarity,
                desc: `${isWeapon ? 'Êîª' : 'Èò≤'} +${val}`
            };

            // Show Modal
            const d = document.getElementById('loot-display');
            d.innerHTML = `
                <div class="font-bold text-lg rarity-${Game.tempLoot.rarity}">${Game.tempLoot.name}</div>
                <div class="text-sm text-gray-600 mt-1">${Game.tempLoot.desc}</div>
                <div class="text-xs text-gray-400 mt-2 uppercase">${Game.tempLoot.rarity}</div>
            `;
            document.getElementById('loot-modal').classList.remove('hidden');
            Game.state = 'loot';
        }

        function takeLoot() {
            if (Game.player.inventory.length >= CONFIG.maxInventory) {
                alert("ÊåÅ„Å°Áâ©„Åå„ÅÑ„Å£„Å±„ÅÑ„Åß„ÅôÔºÅ");
                return;
            }
            Game.player.inventory.push(Game.tempLoot);
            log(`${Game.tempLoot.name}„ÇíÊâã„Å´ÂÖ•„Çå„Åü`);
            closeLoot();
        }

        function discardLoot() {
            log("ÂÆùÁÆ±„ÇíÁÑ°Ë¶ñ„Åó„Åü");
            closeLoot();
        }

        function closeLoot() {
            document.getElementById('loot-modal').classList.add('hidden');
            Game.state = 'idle'; // ready for next floor
            updateUI();
        }

        // --- UI & UTILS ---
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`content-${tab}`).classList.add('active');
        }

        function getStats() {
            let s = Game.player.baseStr;
            let d = Game.player.baseDef;
            if (Game.player.equipment.weapon) s += Game.player.equipment.weapon.val;
            if (Game.player.equipment.armor) d += Game.player.equipment.armor.val;
            return { str: s, def: d };
        }

        function equip(idx) {
            const item = Game.player.inventory[idx];
            const old = Game.player.equipment[item.type];
            if (old) Game.player.inventory.push(old);
            
            Game.player.equipment[item.type] = item;
            Game.player.inventory.splice(idx, 1);
            updateUI();
        }

        document.getElementById('rest-btn').onclick = () => {
            if (Game.state !== 'idle') {
                log("Êïµ„Åå„ÅÑ„ÇãÔºÅ‰ºë„ÇÅ„Å™„ÅÑÔºÅ", "text-red-500"); return;
            }
            Game.player.currentHp = Game.player.maxHp;
            Game.player.currentMp = Game.player.maxMp;
            log("ÂÖ®ÂõûÂæ©„Åó„Åü„ÄÇ", "text-green-600");
            updateUI();
        };

        function spawnDamageText(val, type) {
            const el = document.createElement('div');
            el.className = `damage-text left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-3xl ${type==='heal'?'text-green-500':'text-red-600'}`;
            el.innerText = type==='heal' ? `+${val}` : val;
            document.getElementById('damage-layer').appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function updateUI() {
            // Stats
            const p = Game.player;
            const stats = getStats();
            document.getElementById('floor-display').innerText = Game.floor;
            document.getElementById('enemy-lvl-display').innerText = Math.floor((Game.floor*0.4)+1);
            
            document.getElementById('player-hp-text').innerText = `${p.currentHp}/${p.maxHp}`;
            document.getElementById('player-hp-bar').style.width = `${(p.currentHp/p.maxHp)*100}%`;
            document.getElementById('player-mp-text').innerText = `${p.currentMp}/${p.maxMp}`;
            document.getElementById('player-mp-bar').style.width = `${(p.currentMp/p.maxMp)*100}%`;

            // Status Tab
            document.getElementById('status-lvl').innerText = p.level;
            document.getElementById('status-exp').innerText = `${p.exp}/${p.nextLevelExp}`;
            document.getElementById('status-exp-bar').style.width = `${(p.exp/p.nextLevelExp)*100}%`;
            document.getElementById('status-atk').innerText = stats.str;
            document.getElementById('status-def').innerText = stats.def;

            // Equipment
            const updateEquipUI = (slot, elId, statId) => {
                const item = p.equipment[slot];
                const el = document.getElementById(elId);
                const st = document.getElementById(statId);
                if (item) {
                    el.innerText = item.name;
                    el.className = `font-bold text-sm truncate rarity-${item.rarity}`;
                    st.innerText = `+${item.val}`;
                } else {
                    el.innerText = "„Å™„Åó";
                    el.className = "text-gray-400 text-sm";
                    st.innerText = "";
                }
            };
            updateEquipUI('weapon', 'equip-weapon', 'weapon-stats');
            updateEquipUI('armor', 'equip-armor', 'armor-stats');

            // Inventory
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            document.getElementById('inv-badge').innerText = p.inventory.length;
            document.getElementById('empty-inv-msg').style.display = p.inventory.length ? 'none' : 'block';
            
            p.inventory.forEach((item, idx) => {
                const row = document.createElement('div');
                row.className = "flex justify-between items-center p-2 bg-gray-50 border border-gray-100 rounded hover:bg-gray-100";
                row.innerHTML = `
                    <div class="flex-1 overflow-hidden">
                        <div class="text-sm font-bold truncate rarity-${item.rarity}">${item.name}</div>
                        <div class="text-[10px] text-gray-500">${item.desc}</div>
                    </div>
                    <button onclick="equip(${idx})" class="text-xs bg-gray-800 text-white px-3 py-1.5 rounded shadow active:scale-95">Ë£ÖÂÇô</button>
                `;
                list.appendChild(row);
            });

            // Battle State Visuals
            const btn = document.getElementById('action-btn');
            const enemyCont = document.getElementById('enemy-container');
            
            if (Game.state === 'dead') {
                enemyCont.style.opacity = '0.3';
                return; // Handled in handleDeath
            }

            // Button reset style
            btn.classList.remove('bg-red-700', 'bg-green-600', 'bg-gray-800');
            
            if (Game.state === 'combat') {
                enemyCont.style.opacity = '1';
                document.getElementById('enemy-name').innerText = Game.enemy.name;
                document.getElementById('enemy-visual').innerHTML = `<i class="fas ${Game.enemy.icon}"></i>`;
                document.getElementById('enemy-hp-text').innerText = `${Game.enemy.currentHp}/${Game.enemy.maxHp}`;
                document.getElementById('enemy-hp-bar').style.width = `${(Game.enemy.currentHp/Game.enemy.maxHp)*100}%`;
                
                btn.classList.add('bg-gray-800');
                btn.innerHTML = '<i class="fas fa-sword"></i> <span>ÊîªÊíÉ</span>';
            } else if (Game.state === 'idle') {
                enemyCont.style.opacity = '0.4';
                document.getElementById('enemy-hp-bar').style.width = '0%';
                
                btn.classList.add('bg-green-600');
                btn.innerHTML = '<i class="fas fa-shoe-prints"></i> <span>Ê¨°„ÅÆÈöéÂ±§„Å∏</span>';
            }
        }
        
        function log(msg, cls="") {
            const div = document.createElement('div');
            div.className = cls;
            div.innerText = `> ${msg}`;
            const cont = document.getElementById('log-container');
            cont.prepend(div); // Newest top
            if (cont.children.length > 30) cont.lastChild.remove();
        }

    </script>
</body>
</html>


